<!-- Map & GPS Script -->
<script>
  const pubnub = new PubNub({
    publishKey: 'pub-c-b34ec225-e227-4a75-b8b7-45958644f07f',
    subscribeKey: 'sub-c-1a48de9d-bfef-4c59-b911-5f400664dc60',
    uuid: 'web-tracker'
  });

  const channel = 'gps-tracker';
  let map;
  const markers = {}; // ðŸ‘ˆ New: store markers by device UUID

  function initMap() {
    const defaultLoc = { lat: 42.372240525186385, lng: -71.1336323150142 };
    map = new google.maps.Map(document.getElementById('map'), {
      center: defaultLoc,
      zoom: 2,
      styles: [ /* ...map styling here... */ ]
    });
  }

  window.onload = () => {
    initMap();
    pubnub.subscribe({ channels: [channel] });
    pubnub.addListener({
      message: function(event) {
        const { latitude, longitude, uuid } = event.message; // ðŸ‘ˆ Expect each message to contain uuid
        if (latitude && longitude && uuid) {
          const position = { lat: latitude, lng: longitude };

          // If marker for this device doesn't exist yet, create it
          if (!markers[uuid]) {
            markers[uuid] = new google.maps.Marker({
              position: position,
              map: map,
              title: `Device: ${uuid}`,
              label: {
                text: uuid.substring(0, 4), // Short label from UUID
                color: "white",
                fontSize: "10px",
                fontWeight: "bold"
              }
            });
          } else {
            // If exists, just update the marker's position
            markers[uuid].setPosition(position);
          }

          map.setCenter(position);
          map.setZoom(16);
        }
      }
    });
  };
</script>
